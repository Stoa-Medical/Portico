# Backend Services

Portico's backend is the **heart** of the system. It is intentionally small—two micro-services and a managed Postgres provided by Supabase.

```
server/
  ├─ engine/   # Rust gRPC runtime
  ├─ bridge/   # Python realtime listener
  └─ docker-compose.yml
```

## Engine (Rust – `server/engine`)

* **Entrypoint**: `server/engine/src/main.rs`
* **Frameworks**: `tonic` (gRPC), `sqlx` (database).
* At startup it:
  1. Reads `POSTGRES_DB_URI` and connects using a connection-pool.
  2. Hydrates an in-memory `HashMap<AgentUuid, Agent>`.
  3. Exposes a gRPC service (`RpcServer`) with one queue per Agent.
* Each incoming message is handled by a **thread-pool** so that long-running `Step`s do not block the dispatcher.
* After a run it persists a `RuntimeSession` row and updates the originating `Signal` with the result.

### Database Layer

All typed models live in the shared crate `lib/shared` so that both Engine **and** the desktop app compile against the same structs. Queries are validated at compile time via `sqlx`'s offline mode (see `shared_prepare` container in *docker-compose*).

## Bridge (Python – `server/bridge`)

* **Entrypoint**: `server/bridge/src/main.py`
* Uses `supabase-py` to subscribe to:
  * `signals` INSERTs (run/sync/fyi)
  * `agents` INSERT/DELETEs
* Converts each realtime payload into a protobuf message generated by `src/proto/build_proto.py`, then calls the Engine over gRPC.
* Writes back any status/error to Supabase if necessary.

Why Python? At the time of writing the Rust ecosystem lacks a stable Supabase Realtime SDK; a thin Python façade keeps this dependency isolated.

## Supabase (Postgres + Realtime)

* Brought up locally by `docker compose`.
* Schema file: `server/schema.hcl` (managed with *Atlas*).
* Serves three roles:
  1. Authoritative data store.
  2. Auth provider for the UI.
  3. Realtime event bus consumed by Bridge.

> NOTE: Because we lean on Supabase's logical replication stream, **all writes must go through Supabase/PostgREST** so that downstream services receive the events.
